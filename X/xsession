#!/bin/sh

## ================================================================
## Set up X.org
## ================================================================
setxkbmap -option "compose:menu"           # Set compose key
export GTK_IM_MODULE=xim                   # Ugly hack for GTK

[ -f ~/.Xresources ] && xrdb ~/.Xresources # Read resources
[ -f ~/.Xmodmap    ] && xmodmap ~/.Xmodmap # read modmaps


## ================================================================
## Download wallpaper from APOD
## ================================================================
xsetroot -solid black
apod_get_wallpaper.sh &


## ================================================================
## Launch kdeinit (needed for KDE apps)
## ================================================================
kdeinit 


## ================================================================
## Run bars
## ================================================================
# System tray
stalonetray -bg '#eee' --icon-size 18 --geometry 144x18+0+0 &
# MPD status bar
xbar_mpd | dzen2 -ta l -w 566 -x 144 -e '' &
# Memory meter
xbar_mem | dzen2 -w 144 -x 710 -e '' &
# dzen clock
dzen_clock | dzen2 -x $((1024-170)) -w 170 \
    -e 'button1=exec:dzen_cal 760 0 264' &


## ================================================================
## Run window manager
## ================================================================
/usr/bin/xmonad &
XMONAD_PID=$!


## ================================================================
## Autorun
## ================================================================
AUTORUN=~/.etc/autorun
[ -f $AUTORUN ] && sh $AUTORUN &


## ================================================================
## Cleanup
## ================================================================
# wait for xmonad termination
wait $XMONAD_PID
# send SIGHUP to all children
pkill -HUP -P $$
# Stop music
mpc pause
# Wait for everyone to terminate
wait
