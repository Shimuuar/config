#!/bin/sh

## ================================================================
## Set up X.org
## ================================================================
# Set xkb options
setxkbmap -model pc104 -layout us,ru -variant basic,winkeys 
setxkbmap -option -option "grp_led:scroll,grp:shifts_toggle,compose:menu,ctrl:nocaps" 

[ -f ~/.Xresources ] && xrdb ~/.Xresources # Read resources
[ -f ~/.Xmodmap    ] && xmodmap ~/.Xmodmap # read modmaps

# Cleanup resources
rm -rf .macromedia/*

## ================================================================
## Set input methods
## ================================================================
export GTK_IM_MODULE=xim
# if which scim; then
#     export XMODIFIERS='@im=scim-bridge'
#     export GTK_IM_MODULE="scim-bridge"
#     export QT_IM_MODULE="scim-bridge"
#     scim -d
# fi

## ================================================================
## Run session programs
## ================================================================
killall gpg-agent
eval $(gpg-agent --daemon)
which mpdscribble && mpdscribble --conf ~/.mpdscribble/mpdscribble
which conky       && exec conky                            &
which tint2       && exec tint2 -c ~/.config/tint2/tint2rc &

## ================================================================
## Wallpaper
## ================================================================

# Directory with wallpapers
WALLPAPERDIR=~/.wallpaper.d/$(xrandr -q 2>&1 | sed -re '/\* *$/!d; s/^ +([0-9]+x[0-9]+).*/\1/')

# Directory with wallpapers is nonempty. Display random image
if [ -d "$WALLPAPERDIR" ] && [ ! -z "$(ls "$WALLPAPERDIR"/)" ]; then
    feh --bg-center "$WALLPAPERDIR"/$(ls "$WALLPAPERDIR" | sort -R | head -1)
# There is .wallpaper
elif [ -f ~/.wallpaper ]; then
    feh --bg-center ~/.wallpaper
# Fill with some non-black color
else
    xsetroot -solid lightgreen
fi


## ================================================================
## Run window manager
## ================================================================
xmonad &
XMONAD_PID=$!


## ================================================================
## Autorun
## ================================================================
AUTORUN=~/.config/autorun
[ -f $AUTORUN ] && sh $AUTORUN &


## ================================================================
## Cleanup
## ================================================================
wait $XMONAD_PID		# wait for xmonad termination
pkill -TERM -P $$		# send SIGTERM to all children
mpc pause			# Stop music
wait				# Wait for everyone to terminate

