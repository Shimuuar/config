#!/bin/sh

## ================================================================
## Set up X.org
## ================================================================
# Set xkb options
setxkbmap -model pc104 -layout us,ru -variant basic,winkeys 
setxkbmap -option -option "grp_led:scroll,grp:shifts_toggle,compose:menu,ctrl:nocaps" 

export GTK_IM_MODULE=xim                   # Force GTK to accept Composed keys

[ -f ~/.Xresources ] && xrdb ~/.Xresources # Read resources
[ -f ~/.Xmodmap    ] && xmodmap ~/.Xmodmap # read modmaps


## ================================================================
## Run session programs
## ================================================================
eval $(gpg-agent --daemon)
mpdscribble --conf ~/.mpdscribble/mpdscribble

## ================================================================
## APOD wallpaper
## ================================================================
xsetroot -solid black
WALLPAPER=${HOME}/.local/share/apod/wallpaper
[ -f $WALLPAPER ] && display -backdrop -window root $WALLPAPER;
which inotifywait > /dev/null &&
  while inotifywait -e close_write $WALLPAPER ; do
      display -backdrop -window root $WALLPAPER;
      date > ~/q
  done &


## ================================================================
## Run window manager
## ================================================================
xmonad &
XMONAD_PID=$!


## ================================================================
## Autorun
## ================================================================
AUTORUN=~/.config/autorun
[ -f $AUTORUN ] && sh $AUTORUN &


## ================================================================
## Cleanup
## ================================================================
# wait for xmonad termination
wait $XMONAD_PID
# send SIGHUP to all children
pkill -HUP -P $$
# Stop music
mpc pause
# Wait for everyone to terminate
wait
